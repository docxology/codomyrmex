# Code Execution Sandbox - MCP Tool Specification

This document outlines the specification for tools within the Code Execution Sandbox module that are intended to be integrated with the Model Context Protocol (MCP).

## General Considerations

- **Security**: This module is highly security-sensitive. All tool implementations must prioritize preventing sandbox escapes, resource abuse, and any form of malicious code execution that could impact the host system.
- **Dependencies**: May rely on containerization technologies (e.g., Docker) or language-specific sandboxing libraries.

---

## Tool: `execute_code`

### 1. Tool Purpose and Description

Safely executes a given snippet of code in a specified programming language within an isolated sandbox environment. It returns the standard output, standard error, exit code, and execution time.

### 2. Invocation Name

`execute_code`

### 3. Input Schema (Parameters)

| Parameter Name | Type     | Required | Description                                                                 | Example Value                                    |
| :------------- | :------- | :------- | :-------------------------------------------------------------------------- | :----------------------------------------------- |
| `language`     | `string` | Yes      | The programming language of the code snippet. (e.g., "python", "javascript") | `"python"`                                       |
| `code`         | `string` | Yes      | The source code snippet to be executed.                                     | `"print('Hello, World!')"`                       |
| `stdin`        | `string` | No       | Standard input to be passed to the code during execution.                   | `"Some input data"`                              |
| `timeout`      | `integer`| No       | Maximum execution time in seconds. Default: `30`. Min: `1`, Max: `300`.     | `60`                                             |
| `session_id`   | `string` | No       | An optional session identifier if the sandbox needs to maintain state across multiple executions (e.g. for installing packages in a persistent environment). Support for this is highly dependent on implementation. | `"user123_project_alpha"`                        |

**Notes on Input Schema:**
- The list of supported `language` values will depend on the sandbox implementation.
- `code` should be passed as a string. For multi-line code, newlines should be appropriately escaped if sent via JSON (e.g., `\n`).

### 4. Output Schema (Return Value)

| Field Name       | Type     | Description                                                                                          | Example Value                         |
| :--------------- | :------- | :--------------------------------------------------------------------------------------------------- | :------------------------------------ |
| `stdout`         | `string` | The standard output generated by the executed code.                                                  | `"Hello, World!\n"`                   |
| `stderr`         | `string` | The standard error output generated by the executed code. Empty if no errors.                        | `""` or `"Error: Something went wrong\n"` |
| `exit_code`      | `integer`| The exit code returned by the executed process. `0` typically indicates success.                       | `0`                                   |
| `execution_time` | `float`  | The time taken for the code to execute, in seconds.                                                  | `0.123`                               |
| `status`         | `string` | Overall status: "success", "timeout", "execution_error", "setup_error".                            | `"success"`                           |
| `error_message`  | `string` | A descriptive error message if `status` is not "success".                                          | `"Execution timed out after 60 seconds."` |

**Notes on Output Schema:**
- If execution times out, `stdout` and `stderr` might contain partial output.
- `error_message` provides details if the execution failed due to reasons other than code-generated errors (e.g., sandbox setup failure, timeout).

### 5. Error Handling

- **Timeout**: If execution exceeds the `timeout` value, `status` will be "timeout", and `error_message` will indicate this. `exit_code` might be non-zero or system-specific.
- **Execution Error**: If the code itself produces an error (e.g., Python exception), `stderr` will capture it, and `exit_code` will typically be non-zero. `status` will be "execution_error".
- **Setup Error**: If the sandbox cannot be prepared for the given language or parameters, `status` will be "setup_error", and `error_message` will provide details.
- The tool returns `{"status": "[status_code]", "error_message": "description", ...}` for failures not captured by `stdout`/`stderr` from the user code.

### 6. Idempotency

- **Idempotent**: Generally No (if `session_id` is not used or if code has side effects like random number generation). Yes, if the `code` is deterministic, has no external side effects, and `session_id` ensures a consistent environment state for repeated calls.
- **Explanation**: Executing the same code snippet might produce different outputs if the code is non-deterministic (e.g., uses random numbers, current time) or interacts with a changing environment. If `session_id` is supported and used to create a persistent environment, repeated calls within the same session might have cumulative effects (e.g., defining variables, installing packages).

### 7. Usage Examples (for MCP context)

```json
{
  "tool_name": "execute_code",
  "arguments": {
    "language": "python",
    "code": "name = input('Enter your name: ')\nprint(f'Hello, {name}!')",
    "stdin": "Alice",
    "timeout": 10
  }
}
```

Expected output (example):
```json
{
  "stdout": "Hello, Alice!\n",
  "stderr": "",
  "exit_code": 0,
  "execution_time": 0.05,
  "status": "success",
  "error_message": null
}
```

### 8. Security Considerations

- **CRITICAL**: This tool is the most security-sensitive in the project.
- **Input Validation**: `language` must be from a strictly validated allow-list. `code` should be treated as untrusted input. `timeout` must be within strict global limits.
- **Sandboxing**: Execution MUST occur in a strongly isolated environment (e.g., separate container, restricted process with no network access by default, limited CPU/memory/disk).
- **Permissions**: The sandbox environment must run with minimal privileges.
- **Resource Limits**: Strict CPU time, memory usage, disk space, and process count limits must be enforced per execution.
- **Network Access**: Default to NO network access. If specific network access is required for a language or use case (e.g. `pip install`), it must be explicitly configured, audited, and restricted.
- **Filesystem Access**: Default to NO filesystem access to the host or other sensitive paths. If temporary file storage is needed, it must be within a jailed, ephemeral directory.
- **Data Handling**: Avoid execution of code containing PII or sensitive data if possible. If necessary, ensure the sandbox environment and logging do not persist or expose such data.
- **Output Sanitization**: While `stdout` and `stderr` are direct outputs, be cautious if these are ever rendered directly in web UIs without sanitization elsewhere.
- **Regular Audits**: The sandboxing mechanism should be regularly audited for vulnerabilities.

---
