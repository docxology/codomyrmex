{% extends "base.html" %}

{% block title %}Documentation - Codomyrmex{% endblock %}

{% block extra_head %}
<!-- Markdown rendering libraries -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
<!-- Syntax highlighting -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/core.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/python.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/javascript.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/bash.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/languages/json.min.js"></script>
{% endblock %}

{% block content %}
<h1>Documentation Browser</h1>

<div style="display: flex; gap: 2rem;">
    <div style="width: 300px; border-right: 1px solid var(--border-color);">
        <ul class="doc-tree" role="tree">
            {% macro render_tree(node) %}
            <li role="treeitem">
                {% if node.children %}
                <span class="folder" tabindex="0" aria-expanded="true">{{ node.name }}</span>
                <ul role="group">
                    {% for child in node.children %}
                    {{ render_tree(child) }}
                    {% endfor %}
                </ul>
                {% else %}
                <a href="#" class="doc-link" data-path="{{ node.path }}">
                    {{ node.name }}
                </a>
                {% endif %}
            </li>
            {% endmacro %}

            {% for root_node in doc_tree.children %}
            {{ render_tree(root_node) }}
            {% endfor %}
        </ul>
    </div>

    <div style="flex: 1;">
        <div id="doc-content" class="markdown-body">
            <h3>Select a document to view</h3>
        </div>
    </div>
</div>

<script>
    // Configure marked.js for safe rendering
    if (typeof marked !== 'undefined') {
        marked.setOptions({ breaks: true, gfm: true });
    }

    function renderMarkdown(raw) {
        if (typeof DOMPurify !== 'undefined' && typeof marked !== 'undefined') {
            return DOMPurify.sanitize(marked.parse(raw));
        }
        return '<pre>' + raw.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</pre>';
    }

    function highlightCode(container) {
        if (typeof hljs !== 'undefined') {
            container.querySelectorAll('pre code').forEach(function (block) {
                hljs.highlightElement(block);
            });
        }
    }

    // Folder expand/collapse
    document.querySelectorAll('.folder').forEach(function (folder) {
        folder.addEventListener('click', function () {
            const expanded = this.getAttribute('aria-expanded') !== 'false';
            this.setAttribute('aria-expanded', String(!expanded));
            const group = this.nextElementSibling;
            if (group) group.style.display = expanded ? 'none' : '';
        });
        folder.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); this.click(); }
        });
    });

    // Doc link click → fetch content
    document.querySelectorAll('.doc-link').forEach(function (link) {
        link.addEventListener('click', async function (e) {
            e.preventDefault();
            document.querySelectorAll('.doc-link').forEach(function (l) { l.classList.remove('active'); });
            this.classList.add('active');

            const path = this.dataset.path;
            const content = document.getElementById('doc-content');
            content.innerHTML = '<p style="color: var(--text-secondary);">Loading…</p>';

            try {
                const resp = await fetch('/api/docs/' + path.split('/').map(encodeURIComponent).join('/'));
                if (resp.ok) {
                    const data = await resp.json();
                    content.innerHTML = renderMarkdown(data.content || '');
                    highlightCode(content);
                } else {
                    const data = await resp.json();
                    content.innerHTML = '<p style="color: var(--error-color);">Error: ' + (data.error || resp.status) + '</p>';
                }
            } catch (err) {
                content.innerHTML = '<p style="color: var(--error-color);">Connection error: ' + err.message + '</p>';
            }
        });
    });

    // Auto-open first doc on page load
    const first = document.querySelector('.doc-link');
    if (first) first.click();
</script>
{% endblock %}