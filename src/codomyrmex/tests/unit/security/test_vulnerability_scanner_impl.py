"""Tests for VulnerabilityScanner implementation.

Tests use real code paths -- external tool tests are guarded with skipif.
"""
import os
import shutil
import tempfile

import pytest

from codomyrmex.security.digital.vulnerability_scanner import (
    VulnerabilityReport,
    VulnerabilityScanner,
    check_compliance,
)

# --- Basic scanner tests (no external tools) ---


def test_vulnerability_scanner_instantiation():
    """Scanner can be instantiated."""
    scanner = VulnerabilityScanner()
    assert scanner is not None
    assert isinstance(scanner.config, dict)


def test_default_config_has_required_keys():
    """Default config has expected keys."""
    scanner = VulnerabilityScanner()
    assert "scan_types" in scanner.config
    assert "severity_threshold" in scanner.config
    assert "compliance_standards" in scanner.config


def test_scan_results_initially_empty():
    """scan_results list starts empty."""
    scanner = VulnerabilityScanner()
    assert scanner.scan_results == []


def test_is_python_project_with_pyproject():
    """Correctly detects Python projects via pyproject.toml."""
    scanner = VulnerabilityScanner()
    with tempfile.TemporaryDirectory() as tmpdir:
        open(os.path.join(tmpdir, "pyproject.toml"), "w").close()
        assert scanner._is_python_project(tmpdir) is True


def test_is_python_project_false_empty_dir():
    """Returns False for empty directory."""
    scanner = VulnerabilityScanner()
    with tempfile.TemporaryDirectory() as tmpdir:
        assert scanner._is_python_project(tmpdir) is False


def test_is_nodejs_project_with_package_json():
    """Correctly detects Node.js projects via package.json."""
    scanner = VulnerabilityScanner()
    with tempfile.TemporaryDirectory() as tmpdir:
        open(os.path.join(tmpdir, "package.json"), "w").close()
        assert scanner._is_nodejs_project(tmpdir) is True


def test_generate_scan_id_unique():
    """Generates unique scan IDs for different paths."""
    scanner = VulnerabilityScanner()
    id1 = scanner._generate_scan_id("/path/one")
    id2 = scanner._generate_scan_id("/path/two")
    assert id1 != id2
    assert id1.startswith("scan_")
    assert id2.startswith("scan_")


def test_calculate_risk_score_empty():
    """Risk score is 0 for empty vulnerability list."""
    scanner = VulnerabilityScanner()
    assert scanner._calculate_risk_score([]) == 0.0


def test_calculate_risk_score_with_critical():
    """Risk score computed for critical vulnerabilities."""
    scanner = VulnerabilityScanner()
    vulns = [{"severity": "CRITICAL"}, {"severity": "HIGH"}]
    score = scanner._calculate_risk_score(vulns)
    assert score > 0.0
    assert score <= 100.0


def test_generate_recommendations_empty():
    """Recommendations for zero vulnerabilities."""
    scanner = VulnerabilityScanner()
    recs = scanner._generate_recommendations([])
    assert len(recs) > 0
    assert any("No" in r or "no" in r for r in recs)


def test_generate_recommendations_with_vulns():
    """Recommendations include count for found vulnerabilities."""
    scanner = VulnerabilityScanner()
    vulns = [{"severity": "HIGH"}, {"severity": "MEDIUM"}]
    recs = scanner._generate_recommendations(vulns)
    assert len(recs) > 0


def test_check_owasp_compliance_returns_list():
    """OWASP compliance check returns list of dicts."""
    scanner = VulnerabilityScanner()
    with tempfile.TemporaryDirectory() as tmpdir:
        results = scanner._check_owasp_compliance(tmpdir)
        assert isinstance(results, list)
        assert len(results) > 0
        assert all(isinstance(r, dict) for r in results)


def test_vulnerability_report_valid_property():
    """VulnerabilityReport.valid reflects scan_status and risk_score."""
    from datetime import datetime, timezone

    report = VulnerabilityReport(
        scan_id="test_id",
        timestamp=datetime.now(timezone.utc),
        target_path="/tmp",
        scan_status="completed",
        risk_score=0.0,
    )
    assert report.valid is True

    report.risk_score = 80.0
    assert report.valid is False


def test_vulnerability_report_to_dict():
    """VulnerabilityReport serializes to dict with expected keys."""
    from datetime import datetime, timezone

    report = VulnerabilityReport(
        scan_id="test_id",
        timestamp=datetime.now(timezone.utc),
        target_path="/tmp",
    )
    d = report.to_dict()
    assert "scan_id" in d
    assert "timestamp" in d
    assert "valid" in d
    assert "risk_score" in d


def test_scan_vulnerabilities_compliance_only():
    """Scanning compliance-only path completes without external tools."""
    scanner = VulnerabilityScanner()
    with tempfile.TemporaryDirectory() as tmpdir:
        report = scanner.scan_vulnerabilities(tmpdir, scan_types=["compliance"])
        assert report.scan_status == "completed"
        assert len(report.compliance_checks) > 0


def test_convenience_check_compliance():
    """check_compliance convenience function returns compliance checks."""
    with tempfile.TemporaryDirectory() as tmpdir:
        results = check_compliance(tmpdir)
        assert isinstance(results, list)


# --- External tool tests (guarded) ---


@pytest.mark.skipif(not shutil.which("pip-audit"), reason="pip-audit not installed")
def test_scan_python_dependencies_returns_list():
    """_scan_python_dependencies returns a list (may be empty)."""
    scanner = VulnerabilityScanner()
    with tempfile.TemporaryDirectory() as tmpdir:
        open(os.path.join(tmpdir, "pyproject.toml"), "w").close()
        result = scanner._scan_python_dependencies(tmpdir)
        assert isinstance(result, list)
        for item in result:
            assert "package" in item
            assert "severity" in item
            assert "source" in item
            assert item["source"] == "pip-audit"


@pytest.mark.skipif(not shutil.which("bandit"), reason="bandit not installed")
def test_scan_code_security_returns_list():
    """_scan_code_security returns a list (may be empty)."""
    scanner = VulnerabilityScanner()
    with tempfile.TemporaryDirectory() as tmpdir:
        # Create a minimal Python file
        with open(os.path.join(tmpdir, "test.py"), "w") as f:
            f.write("x = 1\n")
        result = scanner._scan_code_security(tmpdir)
        assert isinstance(result, list)
        for item in result:
            assert "severity" in item
            assert "source" in item
            assert item["source"] == "bandit"
